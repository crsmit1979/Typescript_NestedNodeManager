class Elem {
    Id?: number;
    Type?: string;
    Children?: Elem[];
    Parent?: Elem;

    constructor(id: number, tp: string) {
        this.Id = id;
        this.Type = tp;
        this.Children = [];
    }

    InsertChildBeforeOrAfter(el: Elem, id:number, position: "before" | "after"){
        var parent = this.FindParentForId(id);
        const index = parent.Children.findIndex(child => child.Id === id);

        if (index !== -1) {
            if (position === "before") {
                el.Parent = this;
                parent.Children.splice(index, 0, el);
            } else if (position === "after") {
                el.Parent = this;
                parent.Children.splice(index + 1, 0, el);
            }
        }        
    }

    /*this will find the item with id and then add the element after it as the next sibling */
    InsertChildAfter(el: Elem, id:number){
        var parent = this.FindParentForId(id);
        const index = parent.Children.findIndex(child => child.Id === id);

        if (index !== -1) {
            el.Parent = this;
            parent.Children.splice(index + 1, 0, el);
        }        
    }

    /*This will append an item to the children of the element with specific id*/
    AddChildToElement(el: Elem, id:number){
        var parent = this.FindParentForId(id);
        el.Parent = this;
        parent.Children.push(el);
    }

    /*this will find the item with id and then add the element before it as the previous sibling */
    InsertChildBefore(el: Elem, id:number){
        var parent = this.FindParentForId(id);
        const index = parent.Children.findIndex(child => child.Id === id);

        if (index !== -1) {
                el.Parent = this;
                parent.Children.splice(index, 0, el);
        }        
    }

    /*this will just add a child to the current elements children */
    AddChild(el: Elem): void {
        el.Parent = this;
        this.Children.push(el);
    }

    /*this will find an element with the specific id either in the current element or any of it's siblings */
    FindById(id: number): Elem | null {
        if (this.Id === id) return this;
        if (this.Children && this.Children.length > 0) {
            for (let x = 0; x < this.Children.length; x++) {
                const child = this.Children[x];
                const found = child.FindById(id);
                if (found !== null) return found;
            }
        }
        return null;
    }

    /*this will search for a specific id in the current element or its children and return the parent element */
    FindParentForId(id: number, parent?: Elem): Elem | null {
        if (this.Id === id) return parent || null;
        if (this.Children && this.Children.length > 0) {
            for (let x = 0; x < this.Children.length; x++) {
                const child = this.Children[x];
                const found = child.FindParentForId(id, this);
                if (found !== null) return found;
            }
        }
        return null;
    }


    /*converts the current objec to a json object */
    toJSON(): any {
        return {
            Id: this.Id,
            Type: this.Type,
            Children: this.Children.map(child => child.toJSON()),
            _parentId: this.Parent?.Id
        };
    }

    Show(): void {
        console.log(this);
    }

    /* will load a json object from a string variable*/
    static Load(json:string): Elem{
       const parsedJson = JSON.parse(json);
        const root = new Elem(parsedJson.Id, parsedJson.Type);

        if (parsedJson.Children && parsedJson.Children.length > 0) {
            root.Children = parsedJson.Children.map((childJson: any) => Elem.LoadChild(childJson, root));
        }

        return root;
    }
    private static LoadChild(json: any, parent: Elem): Elem {
        const child = new Elem(json.Id, json.Type);

        if (json.Children && json.Children.length > 0) {
            child.Children = json.Children.map((childJson: any) => Elem.LoadChild(childJson, child));
        }

        child.Parent = parent;

        return child;
    }
}

var str = `{
  "Id": 1,
  "Type": "doc",
  "Children": [
    {
      "Id": 2,
      "Type": "div",
      "Children": [
        {
          "Id": 3,
          "Type": "txt",
          "Children": []
        }
      ]
    }
  ]
  } `
var doc = Elem.Load(str)
//doc.Show();
/*
const doc = new Elem(1, "doc");
const div = new Elem(2, "div");
const txt = new Elem(3, "txt");
div.AddChild(txt);
doc.AddChild(div);
doc.Show();
*/
// Uncomment the following lines to test FindById
// const foundById = doc.FindById(3);
// console.log("Found by Id:", foundById);

doc.InsertChildBeforeOrAfter(new Elem(3, "table"), 3, "after")
doc.Show();
//console.log(doc.toJSON())
